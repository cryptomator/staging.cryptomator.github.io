"use strict";const BILLING_PORTAL_SESSION_URL=LEGACY_STORE_URL+"/hub/billing-portal-session",CUSTOM_BILLING_URL=LEGACY_STORE_URL+"/hub/custom-billing",GENERATE_PAY_LINK_URL=LEGACY_STORE_URL+"/hub/generate-pay-link",MANAGE_SUBSCRIPTION_URL=LEGACY_STORE_URL+"/hub/manage-subscription",UPDATE_PAYMENT_METHOD_URL=LEGACY_STORE_URL+"/hub/update-payment-method";class HubSubscription{constructor(e,t,n){this._form=e,this._subscriptionData=t,this._subscriptionData.hubId=n.get("hub_id");let s=n.get("return_url");s&&(this._subscriptionData.returnUrl=decodeURIComponent(s)),this._subscriptionData.session=n.get("session"),this._subscriptionData.hubId&&this._subscriptionData.hubId.length>0&&this._subscriptionData.returnUrl&&this._subscriptionData.returnUrl.length>0&&(this._subscriptionData.state="LOADING",this.loadSubscription()),this._paddle=$.ajax({url:"https://cdn.paddle.com/paddle/paddle.js",cache:!0,dataType:"script"}).then(()=>(PADDLE_ENABLE_SANDBOX&&window.Paddle.Environment.set("sandbox"),window.Paddle.Setup({vendor:PADDLE_VENDOR_ID}),window.Paddle))}loadSubscription(){this.loadCustomBilling(()=>{this.loadPrice(()=>{this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"GET",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session}}).done(e=>{this.onLoadSubscriptionSucceeded(e)}).fail(e=>{this.onLoadSubscriptionFailed(e.status,e.responseJSON?.message||"Loading subscription failed.")})})})}onLoadSubscriptionSucceeded(e){this._subscriptionData.token=e.token,this._subscriptionData.details=e.subscription,e.subscription.quantity&&(this._subscriptionData.quantity=e.subscription.quantity),this._subscriptionData.state="EXISTING_CUSTOMER",this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}onLoadSubscriptionFailed(e,t){e==404?(this._subscriptionData.state="NEW_CUSTOMER",this._subscriptionData.errorMessage=""):e==400?(this._subscriptionData.state="CREATE_SESSION",this._subscriptionData.errorMessage=""):(this._subscriptionData.state="CREATE_SESSION",this._subscriptionData.errorMessage=t),this._subscriptionData.inProgress=!1}createSession(){if(!$(this._form)[0].checkValidity()){$(this._form).find(":input").addClass("show-invalid"),this._subscriptionData.errorMessage="Please fill in all required fields.";return}this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:BILLING_PORTAL_SESSION_URL,type:"POST",data:{captcha:this._subscriptionData.captcha,hub_id:this._subscriptionData.hubId,return_url:this._subscriptionData.returnUrl}}).done(e=>{this.onCreateSessionSucceeded()}).fail(e=>{this.onCreateSessionFailed(e.responseJSON?.message||"Creating billing portal session failed.")})}onCreateSessionSucceeded(){this._subscriptionData.state="CREATE_SESSION_SUCCESS",this._subscriptionData.inProgress=!1,this._subscriptionData.errorMessage=""}onCreateSessionFailed(e){this._subscriptionData.inProgress=!1,this._subscriptionData.errorMessage=e}loadCustomBilling(e){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:CUSTOM_BILLING_URL,type:"GET",data:{hub_id:this._subscriptionData.hubId}}).done(t=>{this.onLoadCustomBillingSucceeded(t),t.custom_billing.manual_invoice?this._subscriptionData.state="MANUAL_INVOICE":e()}).fail(t=>{this.onLoadCustomBillingFailed(t.status,t.responseJSON?.message||"Loading custom billing options failed."),t.status==404&&t.responseJSON?.status=="error"&&e()})}onLoadCustomBillingSucceeded(e){this._subscriptionData.customBilling=e.custom_billing,this._subscriptionData.quantity=this._subscriptionData.customBilling.quantity||this._subscriptionData.quantity,this._subscriptionData.email=this._subscriptionData.customBilling.email||this._subscriptionData.email,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}onLoadCustomBillingFailed(e,t){e==404?(this._subscriptionData.customBilling=null,this._subscriptionData.errorMessage=""):this._subscriptionData.errorMessage=t,this._subscriptionData.inProgress=!1}loadPrice(e){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="";let t;this._subscriptionData.customBilling?.managed?t=PADDLE_HUB_MANAGED_SUBSCRIPTION_PLAN_ID:t=PADDLE_HUB_SELF_HOSTED_SUBSCRIPTION_PLAN_ID,$.ajax({url:PADDLE_PRICES_URL,dataType:"jsonp",data:{product_ids:t}}).done(t=>{this.onLoadPriceSucceeded(t),e()}).fail(e=>{this.onLoadPriceFailed(e.responseJSON?.message||"Loading price failed.")})}onLoadPriceSucceeded(e){let t=e.response.products[0],i=t.currency,n,s,o,a;if(this._subscriptionData.customBilling?.override?.prices){n=this.getAmount(this._subscriptionData.customBilling.override.prices,i)/12,s=this.getAmount(this._subscriptionData.customBilling.override.recurring_prices,i)/12;let e=t.subscription.price.gross/t.subscription.price.net;o=n*e,a=s*e}else n=t.subscription.price.net/12,s=n,o=t.subscription.price.gross/12,a=o;this._subscriptionData.monthlyPrice={netAmount:n,recurringNetAmount:s,grossAmount:o,recurringGrossAmount:a,currency:i},this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}getAmount(e,t){let s=new RegExp(`^${t}:`),n=e.find(e=>s.test(e));return n?parseFloat(n.split(":")[1]):null}onLoadPriceFailed(e){this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}checkout(e){if(!$(this._form)[0].checkValidity()){$(this._form).find(":input").addClass("show-invalid"),this._subscriptionData.errorMessage="Please fill in all required fields.";return}this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",this._subscriptionData.customBilling?.managed?this.customCheckout(PADDLE_HUB_MANAGED_SUBSCRIPTION_PLAN_ID,e):this.customCheckout(PADDLE_HUB_SELF_HOSTED_SUBSCRIPTION_PLAN_ID,e)}customCheckout(e,t){$.ajax({url:GENERATE_PAY_LINK_URL,type:"POST",data:{hub_id:this._subscriptionData.hubId,product_id:e,quantity:this._subscriptionData.quantity}}).done(e=>{this.openPaddleCheckout(e.pay_link,t)}).fail(e=>{this.onPostFailed(e.responseJSON?.message||"Generating pay link failed.")})}openPaddleCheckout(e,t){this._paddle.then(n=>{n.Checkout.open({override:e,email:this._subscriptionData.email,locale:t,passthrough:'{"hub_id": '+this._subscriptionData.hubId+"}",successCallback:e=>this.getPaddleOrderDetails(e.checkout.id),closeCallback:()=>{this._subscriptionData.inProgress=!1}})})}getPaddleOrderDetails(e){this._paddle.then(t=>{t.Order.details(e,e=>{let t=e.order.subscription_id;t?this.post(t):this._subscriptionData.errorMessage="Retrieving subscription failed. Please check your emails instead."})})}post(e){$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"POST",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,subscription_id:e}}).done(e=>{this.onPostSucceeded(e)}).fail(e=>{this.onPostFailed(e.responseJSON?.message||"Adding subscription failed.")})}onPostSucceeded(e){this._subscriptionData.state="EXISTING_CUSTOMER",this._subscriptionData.token=e.token,this._subscriptionData.details=e.subscription,this._subscriptionData.session=e.session;var n,t=new URLSearchParams(window.location.search);t.set("session",e.session),n=window.location.pathname+"?"+t.toString(),history.pushState(null,"",n),this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1,this.transferTokenToHub()}onPostFailed(e){this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}updatePaymentMethod(e){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:UPDATE_PAYMENT_METHOD_URL,type:"GET",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,subscription_id:this._subscriptionData.details.subscription_id}}).done(t=>{this._paddle.then(n=>{n.Checkout.open({override:t.url,locale:e,successCallback:e=>this.loadSubscription(),closeCallback:()=>{this._subscriptionData.inProgress=!1}})})}).fail(e=>{this.onPutFailed(e.status,e.responseJSON?.message||"Updating payment method failed.")})}pause(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,pause:!0}}).done(e=>{this.onPutSucceeded(e,!1)}).fail(e=>{this.onPutFailed(e.status,e.responseJSON?.message||"Updating subscription failed.")})}askForRestartConfirmation(){this._subscriptionData.restartModal.nextPayment=null,this._subscriptionData.restartModal.open=!0,this.previewRestart()}previewRestart(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,pause:!1,preview:!0}}).done(e=>{this._subscriptionData.restartModal.nextPayment=e.subscription.next_payment,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}).fail(e=>{this.onPutFailed(e.status,e.responseJSON?.message||"Calculating price failed.")})}restart(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,pause:!1}}).done(e=>{this.onPutSucceeded(e,this._subscriptionData.details.state=="paused")}).fail(e=>{this.onPutFailed(e.status,e.responseJSON?.message||"Updating subscription failed.")})}openChangeSeatsModal(){this._subscriptionData.quantity=this._subscriptionData.details.quantity,this._subscriptionData.changeSeatsModal.immediatePayment=null,this._subscriptionData.changeSeatsModal.confirmation=!1,this._subscriptionData.changeSeatsModal.open=!0}askForChangeSeatsConfirmation(){if(!$(this._form)[0].checkValidity()){$(this._form).find(":input").addClass("show-invalid"),this._subscriptionData.errorMessage="Please fill in all required fields.";return}this._subscriptionData.changeSeatsModal.confirmation=!0,this.previewChangeQuantity()}previewChangeQuantity(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,quantity:this._subscriptionData.quantity,preview:!0}}).done(e=>{this._subscriptionData.changeSeatsModal.immediatePayment=e.subscription.immediate_payment,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}).fail(e=>{this.onPutFailed(e.status,e.responseJSON?.message||"Calculating price failed.")})}changeQuantity(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:MANAGE_SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,session:this._subscriptionData.session,quantity:this._subscriptionData.quantity}}).done(e=>{this._subscriptionData.changeSeatsModal.open=!1,this.onPutSucceeded(e,!0)}).fail(e=>{this.onPutFailed(e.status,e.responseJSON?.message||"Updating subscription failed.")})}onPutSucceeded(e,t){this._subscriptionData.token=e.token,this._subscriptionData.details=e.subscription,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1,t&&this.transferTokenToHub()}onPutFailed(e,t){e==401&&(this._subscriptionData.state="CREATE_SESSION"),this._subscriptionData.errorMessage=t,this._subscriptionData.inProgress=!1}transferTokenToHub(){window.open(this._subscriptionData.returnUrl+"?token="+this._subscriptionData.token,"_self")}}